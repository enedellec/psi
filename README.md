# VM creation in Azure
- Go to [Microsoft Azure Portal](https://portal.azure.com)
- SGX enabled VM are not available with the free subscription, so you must pay for the usage of such VMs
- You will need to create a [SSH Key](https://portal.azure.com/#view/HubsExtension/BrowseResource/resourceType/Microsoft.Compute%2FsshPublicKeys) that you will store in Azure
- Launch a Cloud Shell, and upload the files located in the `azure` folder, or clone the source code of the project : `git clone https://github.com/enedellec/psi.git` in order to access to the files located in the `azure` folder
- Replace the string `ssh-rsa XXXX generated-by-azure` in both `parameters-server.json` and `parameters-client.json` files with your own SSH public key, which has been generated by Azure
- In your Cloud Shell `$HOME` folder, create a `key.pem` file containing your SSH private key generated by Azure 
- Launch the `deploy.sh` script in order to create two differents VM
- If you face some issues like `bash: ./deploy.sh: /bin/bash^M: bad interpreter: No such file or directory`, you can delete the `^M` character using that command `sed -i -e 's/\r$//' deploy.sh`
- Open a new Cloud Shell, and connect on both VM by launching `./connect-client.sh` in one terminal, and `./connect-server.sh` in the other one
- Copy the `install.sh` file in the two VM, and launch that script in both VM in order to install EGO and libPSI

# Datasets for the test
- Data for testing are available in the `data` folder and generated by the GO program located in the `data-generation` folder
- Each file contains a list of sorted SHA256 hashes
- When testing, the goal is to use two files with the same number of items, with the half of items in common
- Dataset filename follows that convention, : data-XXX-YYY.csv, where :
    - XXX corresponds to the number of items in the file
    - YYY corresponds to either *all* or *even-only* values; *all* means that SHA256 values have been generated from integers between 0 and (XXX-1), and *even-only* means that SHA256 values have been generated from even integers between 0 and (2*XXX-1).
- For more information on the generation of data, you just need to have a look on the `main.go` file in the `data-generation` folder
 
# PSI without enclaves in a single VM
- Select one of the VM created above, and open two terminals
- In the first one, enter the following command
```
cd ~/psi/without-enclaves/server
go run .
```
- The server will wait for incoming requests 
- In the second one, enter the following command:
```
cd ~/psi/without-enclaves/client
go run . --file=../../data/data-100-all.csv
```
- You can check the response of the request in the `result.txt` file, it should be written `You are the first one, I am waiting for your partner`.
- Then, enter the following command, still in the second terminal:
```
go run . --file=../../data/data-100-even-only.csv
```
- You can check the response of the request in the `result.txt` file, you should find the result of the set intersection.
- The content of the `result.txt` should be equal to the intersection between `data-100-all.csv` and `data-100-even-only.csv` files. To validate the result provided by the PSI server, you can try that command :
```
grep -Fx -f ../../data/data-100-all.csv ../../data/data-100-even-only.csv > perfect_result.txt
diff result.txt perfect_result.txt
```
- It should not display any SHA256 hashes


# PSI without enclaves on two different VM
- If you want to test from two different VM, you can specify the `remoteURL` parameter as below, where `1.2.3.4` is the IP address of the server that you must specify:
```
cd ~/psi/without-enclaves/client
go run . --file=../../data/data-100-all.csv --remoteURL=http://1.2.3.4:8080/upload
```

# PSI with enclaves in a single VM
- That project relies on remote attestation, and more specifically on the DCAP server provided by Microsoft in Azure. The source code is based on the [Azure Attestation Sample](https://github.com/edgelesssys/ego/tree/master/samples/azure_attestation) from the [Ego Open Source project](https://github.com/edgelesssys/ego).

- Select one VM, the one corresponding to the server for example.
- You must build the server thanks to the `ego` builder:
```
cd ~/psi/with-enclaves
ego-go build
ego sign server
ego run server
```
- Then, open another terminal one the same VM, and build the client with a recent GO compiler:
```
cd ~/psi/with-enclaves
go build ra_client/client.go
```
- As explained in the [Azure Attestation Sample](https://github.com/edgelesssys/ego/tree/master/samples/azure_attestation), the client expects the `signerID` (MRSIGNER) as an argument. The `signerID` can be derived from the signer's public key using `ego signerid`. 
- Launch the two clients in the second terminal :
```
./client -file "../data/data-100-all.csv" -s `ego signerid public.pem`
./client -file "../data/data-100-even-only.csv" -s `ego signerid public.pem`
```
- You can check the result of the intersection in the `result.txt` file 

# PSI with enclaves on two different VM
- If you want to test with the server on a VM, and the clients on another VM, you can specify the `remoteURL` parameter as below, where `1.2.3.4` is the IP address of the server that you must specify:
```
./client -a 1.2.3.4 -file "../data/data-100-all.csv" -s `ego signerid public.pem`
./client -a 1.2.3.4 -file "../data/data-100-even-only.csv" -s `ego signerid public.pem`
```
# libPSI in a single VM
- Select one of the VM created above, and open two terminals
- In the first terminal, enter the following commands:
``` 
cd ~/libPSI/out/build/linux/frontend
./frontend.exe -rr17a -r 1 -in ~/psi/data/data-100-all.csv -out output.csv
``` 
- In the second one, enter the following commands:
``` 
cd ~libPSI/out/build/linux/frontend
./frontend.exe -rr17a -r 0 -in ~/psi/data/data-100-even-only.csv
``` 
- The result of the intersection is in the `output.csv` file, and it corresponds to a vector with 0 and 1 values
# libPSI with two different VM
- If the receiver and the sender are in two different VM, you must specify the IP address of the receiver.
- In the first VM, you must enter the following commands for launching the receiver :
``` 
cd ~/libPSI/out/build/linux/frontend
./frontend.exe -rr17a -r 1 -ip 0.0.0.0:1212 -in ~/psi/data/data-100-all.csv -out output.csv
``` 
- In the second one, you must enter the following commands for launching the sender (where `1.2.3.4` is the IP address of the receiver in the example below):
``` 
cd ~/libPSI/out/build/linux/frontend
./frontend.exe -rr17a -r 0 -ip 1.2.3.4:1212 -in data-100-even-only.csv
``` 